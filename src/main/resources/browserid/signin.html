<!DOCTYPE html>
<html>
<head>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="https://browserid.org/include.js"></script>
<script type="text/javascript">
	//// Copied from eyedee.me - don't know why this isn't build in to include.js or equivalent...

	(function() {
		"use strict";

		if (!navigator.id) {
			navigator.id = {};
		}

		function getParameterByName(name) {
			name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
			var regexS = "[\\?&]" + name + "=([^&#]*)";
			var regex = new RegExp(regexS);
			var results = regex.exec(window.location.href);
			if (results == null)
				return "";
			else
				return decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		if (!navigator.id.beginAuthentication
				|| navigator.id._primaryAPIIsShimmed) {
			navigator.id.beginAuthentication = function(cb) {
				if (typeof cb !== 'function') {
					throw ".beginAuthentication() requires a callback argument";
				}
				var email = getParameterByName('email');
				setTimeout(function() {
					cb(email);
				}, 0);
			};

			navigator.id.completeAuthentication = function(cb) {
				window.location = getParameterByName('return_to');
			};

			navigator.id.raiseAuthenticationFailure = function(reason) {
				window.location = getParameterByName('return_to');
			};

			navigator.id._primaryAPIIsShimmed = true;
		}
	}());

	////

	console.log("beginning....");
	$(document).ready(function() {
		console.log("ready called");
		navigator.id.beginAuthentication(function(email) {
			console.log("beginning authentication" + email);
			$("#hiddenemail").val(email);
		})
		$("#login").click(function() {
			console.log("login clicked...");
			$.ajax({
				url : "/browserid/signin",
				type : "post",
				dataType : "json",
				data : {
					"email" : $("#hiddenemail").val(),
					"password" : $("#password").val()
				},
				success : function(data, textStatus, jqXHR) {
					console.log(JSON.stringify(data));
					if(data.success){
						navigator.id.completeAuthentication();
					}else{
						$("#error").text("login failed... feel free to try again");
					}
				},
				error : function(jqXHR, textStatus, errorThrown) {
					console.log(textStatus);
				}
			});
		});
	})
</script>
</head>
<body>
	Please sign in...
	<form>
		<input type="hidden" name="email" id="hiddenemail"> <input
			type="password" name="password" id="password"> <input type="button"
			id="login" value="login">
	</form>
	<div id="error"></div>
</body>
</html>
